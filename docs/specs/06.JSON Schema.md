#  **JSON Schema**

------

## A) JSON Schema（v1）

### A.0 通用 Envelope（所有消息必带）

建议所有前端↔Master 的 JSON 消息都包一层 envelope，统一字段便于路由、版本、调试、演进：

**EnvelopeV1**

```json
{
  "$id": "https://webcli.example/schema/envelope.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "WebCLI Envelope v1",
  "type": "object",
  "required": ["v", "type", "instance_id"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "minLength": 1 },
    "instance_id": { "type": "string", "minLength": 8, "maxLength": 128 },

    "seq": { "type": "integer", "minimum": 0 },
    "ts": { "type": "integer", "minimum": 0 },

    "req_id": { "type": "string", "minLength": 8, "maxLength": 64 },
    "trace_id": { "type": "string", "minLength": 8, "maxLength": 64 }
  },
  "additionalProperties": true
}
```

**字段约定**

- `seq`：仅服务端→客户端的 `snapshot/patch` 等状态消息需要；用于丢弃乱序/过期消息（客户端只接受 `seq` 单调递增）。
- `req_id`：用于客户端请求类消息（history.get/resize 等）和服务端响应类消息（history.chunk），方便定位问题。
- `additionalProperties: true`：保证 v1 能安全扩展字段，不会因加字段破坏旧客户端。

------

### A.1 样式表与 Segments（行段）编码

为满足你们“状态同步 + 历史回放”，建议采用“style dictionary + segments”：

#### `StyleMapV1`

```json
{
  "$id": "https://webcli.example/schema/stylemap.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Style Map v1",
  "type": "object",
  "patternProperties": {
    "^[0-9]+$": {
      "type": "object",
      "required": ["bold", "italic", "underline", "inverse"],
      "properties": {
        "fg": { "type": ["integer", "null"], "minimum": 0, "maximum": 255 },
        "bg": { "type": ["integer", "null"], "minimum": 0, "maximum": 255 },
        "bold": { "type": "boolean" },
        "italic": { "type": "boolean" },
        "underline": { "type": "boolean" },
        "inverse": { "type": "boolean" }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
```

#### `SegmentsV1`

每个 segment 是 `[text, styleId]`：

```json
{
  "$id": "https://webcli.example/schema/segments.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Segments v1",
  "type": "array",
  "items": {
    "type": "array",
    "prefixItems": [
      { "type": "string" },
      { "type": "integer", "minimum": 0 }
    ],
    "minItems": 2,
    "maxItems": 2
  }
}
```

------

### A.2 `term.snapshot`（服务端必发）

你们要求每次连接/重连都必须给全量屏幕快照。

```json
{
  "$id": "https://webcli.example/schema/term.snapshot.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.snapshot v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "seq", "size", "cursor", "styles", "rows", "history"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.snapshot" },
    "instance_id": { "type": "string" },
    "seq": { "type": "integer", "minimum": 0 },
    "ts": { "type": "integer", "minimum": 0 },

    "size": {
      "type": "object",
      "required": ["cols", "rows"],
      "properties": {
        "cols": { "type": "integer", "minimum": 1, "maximum": 500 },
        "rows": { "type": "integer", "minimum": 1, "maximum": 300 }
      },
      "additionalProperties": false
    },

    "cursor": {
      "type": "object",
      "required": ["x", "y", "visible"],
      "properties": {
        "x": { "type": "integer", "minimum": 0 },
        "y": { "type": "integer", "minimum": 0 },
        "visible": { "type": "boolean" }
      },
      "additionalProperties": false
    },

    "modes": {
      "type": "object",
      "properties": {
        "appCursor": { "type": "boolean" },
        "wraparound": { "type": "boolean" }
      },
      "additionalProperties": true
    },

    "styles": { "$ref": "https://webcli.example/schema/stylemap.v1.json" },

    "rows": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["y", "segs"],
        "properties": {
          "y": { "type": "integer", "minimum": 0 },
          "segs": { "$ref": "https://webcli.example/schema/segments.v1.json" }
        },
        "additionalProperties": false
      }
    },

    "history": {
      "type": "object",
      "required": ["available", "newest_cursor"],
      "properties": {
        "available": { "type": "integer", "minimum": 0, "maximum": 200000 },
        "newest_cursor": { "type": "string", "minLength": 3, "maxLength": 64 }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
```

**规范建议**

- `rows` 建议包含所有 `0..rows-1` 行（这样前端“快照绘制”不用推断缺失行）。
- `styles` 可以做“按需发送”：只发本次快照中实际出现的 styleId；前端可将 styleId 当作“仅对当前快照有效”的字典。

------

### A.3 `term.patch`（增量整行替换）

你们允许全行替换或补丁，MVP 用全行替换最稳。

```json
{
  "$id": "https://webcli.example/schema/term.patch.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.patch v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "seq", "rows"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.patch" },
    "instance_id": { "type": "string" },
    "seq": { "type": "integer", "minimum": 0 },
    "ts": { "type": "integer", "minimum": 0 },

    "cursor": {
      "type": "object",
      "required": ["x", "y", "visible"],
      "properties": {
        "x": { "type": "integer", "minimum": 0 },
        "y": { "type": "integer", "minimum": 0 },
        "visible": { "type": "boolean" }
      },
      "additionalProperties": false
    },

    "styles": {
      "description": "Optional style dictionary diff; if omitted, styleId must already exist in current style map scope.",
      "$ref": "https://webcli.example/schema/stylemap.v1.json"
    },

    "rows": {
      "type": "array",
      "minItems": 1,
      "maxItems": 300,
      "items": {
        "type": "object",
        "required": ["y", "segs"],
        "properties": {
          "y": { "type": "integer", "minimum": 0 },
          "segs": { "$ref": "https://webcli.example/schema/segments.v1.json" }
        },
        "additionalProperties": false
      }
    }
  },
  "additionalProperties": false
}
```

**客户端处理规则（关键）**

- 如果收到 `seq <= lastSeq`：丢弃（防止乱序/重复）。
- 如果 `seq` 跳跃很大，或出现解码错误：立即发送 `term.resync` 请求（见状态机部分）。

------

### A.4 输入 `term.stdin`（客户端→服务端）

```json
{
  "$id": "https://webcli.example/schema/term.stdin.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.stdin v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "data"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.stdin" },
    "instance_id": { "type": "string" },
    "data": { "type": "string", "maxLength": 65536 }
  },
  "additionalProperties": false
}
```

------

### A.5 历史拉取：`term.history.get` / `term.history.chunk`

你们的历史是服务端环形缓存，前端滚动超出可视区才请求。

#### `term.history.get`

```json
{
  "$id": "https://webcli.example/schema/term.history.get.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.history.get v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "before", "limit", "req_id"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.history.get" },
    "instance_id": { "type": "string" },
    "req_id": { "type": "string", "minLength": 8, "maxLength": 64 },
    "before": { "type": "string", "minLength": 3, "maxLength": 64 },
    "limit": { "type": "integer", "minimum": 1, "maximum": 200 }
  },
  "additionalProperties": false
}
```

#### `term.history.chunk`

```json
{
  "$id": "https://webcli.example/schema/term.history.chunk.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.history.chunk v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "req_id", "lines", "next_before", "exhausted"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.history.chunk" },
    "instance_id": { "type": "string" },
    "req_id": { "type": "string", "minLength": 8, "maxLength": 64 },

    "range": {
      "type": "object",
      "required": ["from", "to"],
      "properties": {
        "from": { "type": "string" },
        "to": { "type": "string" }
      },
      "additionalProperties": false
    },

    "lines": {
      "type": "array",
      "minItems": 0,
      "maxItems": 200,
      "items": {
        "type": "object",
        "required": ["segs"],
        "properties": {
          "segs": { "$ref": "https://webcli.example/schema/segments.v1.json" }
        },
        "additionalProperties": false
      }
    },

    "next_before": { "type": "string", "minLength": 3, "maxLength": 64 },
    "exhausted": { "type": "boolean" }
  },
  "additionalProperties": false
}
```

------

### A.6 resize：`term.resize`（客户端→服务端）

resize 允许清空历史，建议服务端 resize 后直接发新 snapshot。

```json
{
  "$id": "https://webcli.example/schema/term.resize.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.resize v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "size", "req_id"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.resize" },
    "instance_id": { "type": "string" },
    "req_id": { "type": "string", "minLength": 8, "maxLength": 64 },
    "size": {
      "type": "object",
      "required": ["cols", "rows"],
      "properties": {
        "cols": { "type": "integer", "minimum": 1, "maximum": 500 },
        "rows": { "type": "integer", "minimum": 1, "maximum": 300 }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
```

------

### A.7 resync：`term.resync`（客户端→服务端）与服务端响应

当客户端检测到丢包/解析失败/seq 跳跃异常时请求 resync，服务端直接回 snapshot。

#### `term.resync`

```json
{
  "$id": "https://webcli.example/schema/term.resync.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.resync v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "req_id", "reason"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.resync" },
    "instance_id": { "type": "string" },
    "req_id": { "type": "string", "minLength": 8, "maxLength": 64 },
    "reason": {
      "type": "string",
      "enum": ["seq_gap", "decode_error", "client_backpressure", "manual"]
    },
    "last_seq": { "type": "integer", "minimum": 0 }
  },
  "additionalProperties": false
}
```

服务端响应：直接发 `term.snapshot`（A.2）

------

### A.8 进程结束：`term.exit`

```json
{
  "$id": "https://webcli.example/schema/term.exit.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "term.exit v1",
  "type": "object",
  "required": ["v", "type", "instance_id", "code", "message"],
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "type": { "type": "string", "const": "term.exit" },
    "instance_id": { "type": "string" },
    "code": { "type": "integer" },
    "signal": { "type": ["string", "null"] },
    "message": { "type": "string", "maxLength": 200 }
  },
  "additionalProperties": false
}
```

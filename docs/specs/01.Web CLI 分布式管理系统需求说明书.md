# 📋 Web CLI 分布式管理系统

**版本**：2.0  
**状态**：已确认  
**修订日期**：2026-02-14  

---

## 1. 项目背景与目标

开发一个**跨平台、可分布式部署**的 Web 应用，作为 SaaS 服务的一个功能模块，用于**集中创建、配置、交互式操作**由本系统管理的 CLI 程序实例。系统采用 **Master-Slave 架构**，实现**单一公网 Master 节点集中管控大量内网 Slave 节点**上的 CLI 实例。

核心体验要求：用户断线重连时，终端界面**必须精准反映 CLI 进程当前的真实视觉状态**（字符网格、光标位置、颜色样式），与本地执行效果保持一致。

**实施策略**：采用渐进式开发，第一阶段实现**最小可行产品（MVP）**——单机版、无认证、Web直连，聚焦核心终端能力；后续迭代逐步引入分布式、SaaS集成与安全机制。

---

## 2. 核心原则（已共识）

| 维度         | 需求定义                                                     |
| ------------ | ------------------------------------------------------------ |
| **管理范围** | 仅管理系统自身通过 PTY 创建的 CLI 实例，不发现/接管系统已有进程。 |
| **终端交互** | 每个 CLI 实例通过伪终端（PTY）启动，支持标准输入输出及 ANSI 转义序列。 |
| **重连体验** | 强制到底部（最新内容）                                       |
| **配置生效** | 修改全局配置模板**仅影响新创建的实例**；已运行实例保持创建时的配置。 |
| **跨平台**   | 原生支持 Linux / macOS / Windows（含 x86_64 / ARM 架构），**不依赖 tmux/screen 等外部工具**。对于较老 Windows 版本（如 Windows 7），可降级选用备选方案，确保基本功能可用。 |
| **输出处理** | 服务器端使用终端状态的无头模式，保留了完整的解析引擎、缓冲区管理以及转义序列处理能力，作为重连时的终端内容来源。 |
| **安全**     | MVP 阶段不设安全机制（内网信任环境）。后续与 SaaS 集成时，依赖 SaaS 的认证和权限体系，通过 JWT 验证。对于同局域网部署，可配置关闭鉴权，简化使用。 |
| **持久化**   | CLI 进程生命周期独立于用户连接；进程终止后，终端状态自动释放，无需长期存储。 |

---

## 3. 系统架构与演进路线

### 3.1 最终目标架构（SaaS 集成）

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ Browser │      │  SaaS   │      │ Master  │      │  Slave  │
│ (User)  │      │ Backend │      │ (公网)  │      │ (内网)   │
└────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘
     │ 登录           │                 │                 │
     │───────────────>│                 │                 │
     │ 返回 JWT       │                 │                 │
     │<───────────────│                 │                 │
     │                │                 │                 │
     │ 创建实例请求    │                 │                 │
     │───────────────>│                 │                 │
     │                │ gRPC Create     │                 │
     │                │────────────────>│                 │
     │                │                 │ WebSocket指令   │
     │                │                 │────────────────>│
     │                │ 返回 WebSocket  │                 │ PTY创建
     │                │<────────────────│                 │
     │ 返回WebSocket  │                 │                 │
     │<───────────────│                 │                 │
     │                │                 │                 │
     │ WebSocket (WSS)│                 │                 │
     │─────────────────────────────────>│                 │
     │ (携带 JWT)     │                 │ 转发数据         │
     │                │                 │────────────────>│
     │<─────────────────────────────────│<────────────────│
```

- **Master**：公网节点，提供 RPC 接口供 SaaS 调用，维护 Slave 长连接，转发前端 WebSocket 数据。
- **Slave**：内网节点，通过 SaaS 签发的 JWT 主动连接 Master，管理本地 PTY 实例和终端状态。
- **SaaS**：负责用户认证、权限管理、配置存储，签发 JWT，并通过 RPC 与 Master 交互。

### 3.2 局域网简化部署（可选）
- 当 Master 和 Slave 部署在同一局域网（可信任环境）时，可通过配置**关闭鉴权**，简化部署流程，适用于内部测试或小型团队。

### 3.3 第一阶段：MVP 单机版

为快速验证核心终端能力，第一阶段实现**单机一体化模式**，不依赖 SaaS 和认证：

- **程序形态**：单个进程同时扮演 Master 和 Slave 角色（或 Master 内嵌模拟 Slave），运行在用户本地或服务器上。
- **认证**：无，直接通过 HTTP 提供 Web 界面和 WebSocket 服务。
- **Web 前端**：直接连接 Web CLI 服务（同源或配置 CORS）。
- **功能范围**：
  - 创建/终止 CLI 实例（PTY 启动）
  - 实时终端交互（输入输出）
  - 断线重连（强制到底部（最新内容））
  - 窗口尺寸调整
  - 跨平台支持（Windows/Linux/macOS）

**MVP 目标**：验证终端模拟器核心、PTY 封装、重连机制、历史缓冲区的可行性和性能，为后续分布式和 SaaS 集成奠定基础。

---

## 4. 功能需求（覆盖最终目标，MVP 实现子集）

### 4.1 实例生命周期管理

- **创建实例**  
  - 用户通过 Web 表单/API 指定：命令、工作目录、环境变量、初始终端尺寸。  
  - 系统在后台通过 PTY 创建子进程，分配唯一实例 ID，并启动终端模拟器维护状态。  
  - 支持同步创建（立即返回终端界面）或异步创建。  
  - **MVP**：通过 Web UI 表单创建，实例 ID 可简化为本地唯一。

- **查看实例列表**  
  - 聚合展示所有活跃实例（包括本地及受控 Slave 节点上的实例）。  
  - 列表/卡片形式，包含实例 ID、命令、运行时长、所属节点标识。  
  - **MVP**：仅显示本地实例。

- **连接/重连终端**  
  - 用户点击实例卡片进入终端全屏视图。  
  - 建立 WebSocket 连接，服务端立即推送**当前全量屏幕网格**。  
  - 实时转发用户键盘输入至 PTY，并将 PTY 输出解析为增量网格更新，同步至前端。  
  - **断线重连时，服务端再次推送当前终端快照**，确保画面同步。  
  - **MVP**：完全实现。

- **滚动查看历史**  
  - 前端终端组件提供垂直滚动条。  
  - 用户向上滚动超出可视区域时，前端自动向服务端请求缺失的历史行。  
  - 服务端返回指定范围内的历史行数据（带样式），前端插入显示。  
  - **历史缓冲区由服务端维护**，容量可配置（默认 1000 行）。  
  - **MVP**：实现基本按需拉取，历史缓冲区容量可配置。

- **终止实例**  
  - 用户可主动终止 CLI 进程，系统清理 PTY 并释放资源，前端显示 `[Process completed]`。  
  - **MVP**：实现。

- **探活与自动清理**（可选）  
  - 系统定期检查实例进程是否存在，若已终止则标记为“已结束”，并可配置自动删除。  
  - **MVP**：可不实现，后续迭代。

### 4.2 终端交互与重连机制

- **服务端终端模拟器**（Slave 侧）  
  - 维护内存中的二维字符网格（`[][]Cell`），每个单元格包含字符、前景色、背景色、样式属性。  
  - 实时解析 PTY 输出的 ANSI 转义序列，更新网格、光标位置、滚动区域。  
  - 支持标准光标移动、擦除、滚屏、SGR 颜色序列（至少 256 色）。  
  - **维护环形历史缓冲区**：当屏幕内容向上滚动时，被顶出的行追加到历史缓冲区尾部；历史缓冲区容量可配置（默认 1000 行）。  
  - **MVP**：完整实现。

- **前端渲染器**  
  - 不依赖 xterm.js 的历史回放机制。  
  - 首次连接时，根据服务端下发的全量网格绘制终端画面。  
  - 后续接收增量更新（支持全行替换或差异补丁），实现低延迟渲染。  
  - 支持文本选择、复制、右键粘贴等基础交互。  
  - 垂直滚动条：向上滚动超出可视区域时，自动请求历史行并渲染。  
  - **MVP**：实现基本渲染和滚动。

- **窗口尺寸调整**  
  - 用户调整浏览器终端大小时，前端发送新尺寸 → 服务端调用 `PTY.SetSize()` → 终端模拟器调整网格尺寸（调整时清空历史缓冲区，简化实现）。  
  - **MVP**：实现。

### 4.3 配置管理
- **最终目标**：由 SaaS 负责配置模板，创建实例时通过 RPC 传递完整参数。  
- **MVP**：无配置管理，直接通过 Web 表单输入命令。

### 4.4 分布式架构与通信（最终目标）

- **Master-Slave 通信**  
  - 协议：WebSocket（二进制帧）。  
  - Slave 主动连接 Master，携带 JWT 进行认证。  
  - 心跳：Slave 定期发送 ping，Master 响应 pong；超时则断开连接。  
  - 控制指令：Master 向 Slave 发送 JSON 格式指令（创建实例、终止实例、调整窗口、拉取历史）。  
  - 数据转发：前端与实例间的标准输入输出通过二进制帧透传。

- **Master-SaaS 通信**  
  - 协议：RPC over WebSockets  
  - 接口定义见下文。  
  - 安全：同服务器部署时可使用 localhost + 共享密钥验证；若分离部署需 mTLS。

- **前端-Master 通信**  
  - 协议：WebSocket（WSS）。  
  - 连接 URL：`wss://master/ws?instance_id=xxx&token=<JWT>`。  
  - Master 验证 JWT 签名和有效期，并从 token 中提取 `user_id` 和 `allowed_instances`（如有），检查实例权限。

- **局域网免鉴权模式**  
  - 可通过配置 `disable_auth=true` 关闭所有认证检查，适用于可信内网环境。

### 4.5 控制面：RPC over WebSocket（供 SaaS 调用）


SaaS 与 Master 建立连接：
`wss://master/ws/control?token=<JWT>`

所有 RPC 使用统一 JSON 帧：
- Request: {v,type:"req",id,method,deadline_ms,idempotency_key?,payload}
- Response: {v,type:"resp",id,ok,payload?} 或 {error:{code,message,retryable,details?}}

Methods:
- CreateInstance(payload: CreateRequest) -> CreateResponse
- ListInstances(payload: ListRequest) -> ListResponse
- TerminateInstance(payload: TerminateRequest) -> TerminateResponse
- GetWebSocketURL(payload: GetURLRequest) -> GetURLResponse (optional)
- HealthCheck(payload: {}) -> HealthResponse

CreateRequest:
{ user_id, node_id?, command, workdir, env, cols, rows }

CreateResponse:
{ instance_id, websocket_url }

ListRequest:
{ user_id, node_id?, status?, limit, offset }

ListResponse:
{ instances, total }

TerminateRequest:
{ instance_id }


### 4.6 JWT 规范（最终目标）

- **签发者**：SaaS 平台  
- **签名算法**：HS256（共享密钥）或 RS256  
- **Payload 字段**：
  - `user_id` (string) : 用户唯一标识  
  - `allowed_instances` ([]string, optional) : 该用户有权访问的实例 ID 列表（若策略A）  
  - `exp` (int) : 过期时间  
  - `iat` (int) : 签发时间  
  - `node_id` (string, optional) : 当 token 用于 Slave 时，标识节点归属  
- **密钥共享**：Master 与 SaaS 需配置相同的 HMAC 密钥或 RSA 公钥。

### 4.7 单机模式（MVP）

- **程序形态**：单一进程，同时提供 HTTP 服务（前端页面）和 WebSocket 终端服务。  
- **认证**：无。  
- **实例管理**：内存存储，实例 ID 本地唯一。  
- **前端**：直接连接 WebSocket（同源）。  
- **配置**：无全局配置，创建时动态输入。  
- **测试**：可通过浏览器访问 `http://localhost:8080` 使用。

---

## 5. 跨平台支持细节

- **Windows**  
  - 首选：ConPTY（Windows 10 1809+），需显式启用虚拟终端处理。  
  - 备选：对于 Windows 7 等旧版本，可集成 **git-bash** 提供的终端环境（如使用 `winpty` 或 git-bash 自带的 PTY 兼容层），确保基本功能可用。  
  - 默认 Shell：优先使用 PowerShell，可配置。

- **Linux**：标准 `/dev/ptmx`，支持 musl 和 glibc。  
- **macOS**：原生 `forkpty`。  
- **架构**：x86_64, ARM64, ARMv7（可选）。

**禁止依赖**：tmux, screen, bash 特定路径。

---

## 6. 性能指标（最终目标）

- **并发实例**：单 Slave 节点应支持同时运行 **50+** 活跃 CLI 实例。  
- **内存占用**：每个实例的终端网格（默认 80x25）+ 历史缓冲区（1000 行）内存 < 2MB。  
- **网络延迟**：键入到回显延迟 < 100ms（局域网环境）。  
- **历史拉取响应**：请求 50 行历史应在 20ms 内返回。  
- **Master 转发能力**：单 Master 至少支持 **200+** 并发客户端连接及对应 Slave 长连接。

**MVP**：可适当降低指标，但需保证基本流畅。

---

## 7. 明确排除项（不实现）

| 项目             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 进程接管         | 无法附加到系统已有进程（如 `ps` 列出的）。                   |
| 命令白名单/沙箱  | 无命令过滤、资源限制、chroot。                               |
| 前端本地缓存     | 前端不缓存任何终端状态，每次重连全量拉取当前屏幕。           |
| 无限历史         | 不承诺无限期保留历史，仅保留最近 N 行（N 可配置）。          |
| 历史持久化       | 实例终止后历史数据不持久化（可选迭代）。                     |
| 全屏应用完美兼容 | 对 `top`、`vim` 等全屏交互程序退出后屏幕残留问题，仅承诺基本可用，不强制完美恢复（可后续迭代）。 |
| 文件上传/下载    | 本版本不支持通过终端传输文件。                               |
| 多租户复杂权限   | 最终依赖 SaaS 权限体系，Web CLI 自身不做复杂 RBAC。          |

---

## 8. 验收场景（分阶段）

### MVP 阶段验收
1. **单机启动**：在 Windows/Linux/macOS 上运行单机版，浏览器访问页面。  
2. **创建实例**：输入命令 `ping 127.0.0.1`（Linux/macOS）或 `ping -t 127.0.0.1`（Windows），终端显示实时输出。  
3. **断线重连**：关闭标签页，重新打开，终端直接显示最新状态，无历史回放。  
4. **历史滚动**：运行 `for i in {1..200}; do echo "Line $i"; done`，滚动向上查看，验证按需加载。  
5. **窗口调整**：调整浏览器大小，终端布局自适应。  
6. **跨平台验证**：在三平台分别测试，行为一致。

### 最终集成验收（后续阶段）
- 部署公网 Master 和内网 Slave，Slave 使用 SaaS 签发的 token 注册。  
- 通过 SaaS 前端创建实例，连接终端，验证实时交互和重连功能。  
- 测试局域网免鉴权模式。  
- 性能测试达标。

---

## 9. 后续迭代规划建议

1. **MVP 核心终端功能**（本阶段）  
2. **分布式基础**：增加 Master-Slave 模式，Slave 主动连接 Master，支持基本控制指令。  
3. **SaaS 集成**：定义 RPC 接口，实现 JWT 认证，前端直连 Master。  
4. **增强功能**：配置模板、操作日志上报、多节点选择、性能优化。  
5. **生产加固**：TLS、限流、监控、平滑升级。



